{"model_name_or_path": "250522_anthropic_filemap_simple_review__claude-sonnet-4-20250514__t-0.00__p-1.00__c-3.00___swe_bench_verified_test", "instance_id": "django__django-16631", "model_patch": "diff --git a/django/contrib/auth/__init__.py b/django/contrib/auth/__init__.py\nindex 155330c596..3b3d297a60 100644\n--- a/django/contrib/auth/__init__.py\n+++ b/django/contrib/auth/__init__.py\n@@ -199,9 +199,18 @@ def get_user(request):\n             # Verify the session\n             if hasattr(user, \"get_session_auth_hash\"):\n                 session_hash = request.session.get(HASH_SESSION_KEY)\n-                session_hash_verified = session_hash and constant_time_compare(\n-                    session_hash, user.get_session_auth_hash()\n-                )\n+                if session_hash:\n+                    # Use check_session_auth_hash if available (supports fallback keys)\n+                    if hasattr(user, \"check_session_auth_hash\"):\n+                        session_hash_verified = user.check_session_auth_hash(session_hash)\n+                    else:\n+                        # Fallback to old behavior for custom user models\n+                        session_hash_verified = constant_time_compare(\n+                            session_hash, user.get_session_auth_hash()\n+                        )\n+                else:\n+                    session_hash_verified = False\n+                \n                 if not session_hash_verified:\n                     request.session.flush()\n                     user = None\ndiff --git a/django/contrib/auth/base_user.py b/django/contrib/auth/base_user.py\nindex 5ee30bf59c..ad9cb4608e 100644\n--- a/django/contrib/auth/base_user.py\n+++ b/django/contrib/auth/base_user.py\n@@ -142,6 +142,39 @@ class AbstractBaseUser(models.Model):\n             algorithm=\"sha256\",\n         ).hexdigest()\n \n+    def check_session_auth_hash(self, session_hash):\n+        \"\"\"\n+        Check if the given session hash is valid for this user.\n+        This method tries the current SECRET_KEY and all SECRET_KEY_FALLBACKS.\n+        \"\"\"\n+        from django.conf import settings\n+        from django.utils.crypto import constant_time_compare\n+        \n+        key_salt = \"django.contrib.auth.models.AbstractBaseUser.get_session_auth_hash\"\n+        \n+        # Try current secret key first\n+        current_hash = salted_hmac(\n+            key_salt,\n+            self.password,\n+            algorithm=\"sha256\",\n+        ).hexdigest()\n+        \n+        if constant_time_compare(session_hash, current_hash):\n+            return True\n+        \n+        # Try fallback keys\n+        for fallback_key in settings.SECRET_KEY_FALLBACKS:\n+            fallback_hash = salted_hmac(\n+                key_salt,\n+                self.password,\n+                secret=fallback_key,\n+                algorithm=\"sha256\",\n+            ).hexdigest()\n+            if constant_time_compare(session_hash, fallback_hash):\n+                return True\n+        \n+        return False\n+\n     @classmethod\n     def get_email_field_name(cls):\n         try:\n"}