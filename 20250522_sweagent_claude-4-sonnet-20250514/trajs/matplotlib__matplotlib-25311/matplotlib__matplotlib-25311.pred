{"model_name_or_path": "250522_anthropic_filemap_simple_review__claude-sonnet-4-20250514__t-0.00__p-1.00__c-3.00___swe_bench_verified_test", "instance_id": "matplotlib__matplotlib-25311", "model_patch": "diff --git a/lib/matplotlib/offsetbox.py b/lib/matplotlib/offsetbox.py\nindex 1dee8a23d9..952776ce51 100644\n--- a/lib/matplotlib/offsetbox.py\n+++ b/lib/matplotlib/offsetbox.py\n@@ -1505,7 +1505,7 @@ class DraggableBase:\n         if not ref_artist.pickable():\n             ref_artist.set_picker(True)\n         self.got_artist = False\n-        self.canvas = self.ref_artist.figure.canvas\n+        self._canvas = self.ref_artist.figure.canvas\n         self._use_blit = use_blit and self.canvas.supports_blit\n         self.cids = [\n             self.canvas.callbacks._connect_picklable(\n@@ -1580,6 +1580,38 @@ class DraggableBase:\n     def finalize_offset(self):\n         pass\n \n+    def __getstate__(self):\n+        # Exclude canvas from pickling as it may not be picklable (e.g., Qt backends)\n+        state = self.__dict__.copy()\n+        # Remove both canvas and _canvas to avoid pickling issues\n+        state.pop('canvas', None)\n+        state.pop('_canvas', None)\n+        return state\n+\n+    def __setstate__(self, state):\n+        self.__dict__.update(state)\n+        # Restore canvas from ref_artist\n+        # Note: We defer canvas restoration because during unpickling,\n+        # the figure/axes references might not be fully restored yet.\n+        # The canvas will be restored on first access if needed.\n+        self._canvas = None\n+\n+    @property\n+    def canvas(self):\n+        \"\"\"Get the canvas, restoring it from ref_artist if needed.\"\"\"\n+        if self._canvas is None and self.ref_artist:\n+            # Try to get the figure from the ref_artist\n+            if hasattr(self.ref_artist, 'figure') and self.ref_artist.figure:\n+                self._canvas = self.ref_artist.figure.canvas\n+            elif hasattr(self.ref_artist, 'axes') and self.ref_artist.axes and self.ref_artist.axes.figure:\n+                self._canvas = self.ref_artist.axes.figure.canvas\n+        return self._canvas\n+\n+    @canvas.setter\n+    def canvas(self, value):\n+        \"\"\"Set the canvas.\"\"\"\n+        self._canvas = value\n+\n \n class DraggableOffsetBox(DraggableBase):\n     def __init__(self, ref_artist, offsetbox, use_blit=False):\n"}