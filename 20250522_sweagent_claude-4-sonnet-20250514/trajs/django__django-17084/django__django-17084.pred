{"model_name_or_path": "250522_anthropic_filemap_simple_review__claude-sonnet-4-20250514__t-0.00__p-1.00__c-3.00___swe_bench_verified_test", "instance_id": "django__django-17084", "model_patch": "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 13a6809dd8..c53d092444 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -436,6 +436,14 @@ class Query(BaseExpression):\n             )\n             or having\n         )\n+        # Check if any of the aggregates reference window functions\n+        has_window_function_refs = any(\n+            any(\n+                getattr(self.annotations.get(ref), \"contains_over_clause\", False)\n+                for ref in aggregate.get_refs()\n+            )\n+            for aggregate in aggregates.values()\n+        )\n         # Decide if we need to use a subquery.\n         #\n         # Existing aggregations would cause incorrect results as\n@@ -454,6 +462,7 @@ class Query(BaseExpression):\n             or qualify\n             or self.distinct\n             or self.combinator\n+            or has_window_function_refs\n         ):\n             from django.db.models.sql.subqueries import AggregateQuery\n \ndiff --git a/tests/expressions_window/tests.py b/tests/expressions_window/tests.py\nindex 3a02a36707..551a43ee92 100644\n--- a/tests/expressions_window/tests.py\n+++ b/tests/expressions_window/tests.py\n@@ -1577,6 +1577,70 @@ class WindowFunctionTests(TestCase):\n         with self.assertRaisesMessage(NotImplementedError, msg):\n             list(qs.exclude(window=1, department=\"Accounting\"))\n \n+    def test_aggregate_over_window_function(self):\n+        \"\"\"\n+        Test that aggregating over window functions works correctly by using\n+        a subquery. This addresses the issue where window functions inside\n+        aggregate functions would cause SQL errors.\n+        \"\"\"\n+        # Test basic aggregation over window function\n+        qs = Employee.objects.annotate(\n+            cumulative_salary=Window(Sum(\"salary\"), order_by=F(\"hire_date\").asc())\n+        )\n+        result = qs.aggregate(\n+            total_salary=Sum(\"salary\"),\n+            total_cumulative=Sum(\"cumulative_salary\")\n+        )\n+        self.assertIsInstance(result[\"total_salary\"], int)\n+        self.assertIsInstance(result[\"total_cumulative\"], int)\n+        self.assertGreater(result[\"total_cumulative\"], result[\"total_salary\"])\n+\n+        # Test with Coalesce (from the original issue report)\n+        from django.db.models.functions import Coalesce\n+        qs = Employee.objects.annotate(\n+            cumulative_salary=Coalesce(\n+                Window(Sum(\"salary\"), order_by=F(\"hire_date\").asc()), \n+                0, \n+                output_field=IntegerField()\n+            )\n+        )\n+        result = qs.aggregate(\n+            total_salary=Sum(\"salary\"),\n+            total_cumulative=Sum(\"cumulative_salary\")\n+        )\n+        self.assertIsInstance(result[\"total_salary\"], int)\n+        self.assertIsInstance(result[\"total_cumulative\"], int)\n+\n+        # Test multiple aggregates over the same window function\n+        qs = Employee.objects.annotate(\n+            cumulative_salary=Window(Sum(\"salary\"), order_by=F(\"hire_date\").asc())\n+        )\n+        result = qs.aggregate(\n+            total_cumulative=Sum(\"cumulative_salary\"),\n+            avg_cumulative=Avg(\"cumulative_salary\"),\n+            max_cumulative=Max(\"cumulative_salary\"),\n+            min_cumulative=Min(\"cumulative_salary\")\n+        )\n+        self.assertIsInstance(result[\"total_cumulative\"], int)\n+        self.assertIsInstance(result[\"avg_cumulative\"], (Decimal, float))\n+        self.assertIsInstance(result[\"max_cumulative\"], int)\n+        self.assertIsInstance(result[\"min_cumulative\"], int)\n+\n+        # Test with partitioned window function\n+        qs = Employee.objects.annotate(\n+            dept_cumulative=Window(\n+                Sum(\"salary\"), \n+                partition_by=\"department\", \n+                order_by=F(\"hire_date\").asc()\n+            )\n+        )\n+        result = qs.aggregate(\n+            total_salary=Sum(\"salary\"),\n+            total_dept_cumulative=Sum(\"dept_cumulative\")\n+        )\n+        self.assertIsInstance(result[\"total_salary\"], int)\n+        self.assertIsInstance(result[\"total_dept_cumulative\"], int)\n+\n \n class WindowUnsupportedTests(TestCase):\n     def test_unsupported_backend(self):\n"}