{"model_name_or_path": "250522_anthropic_filemap_simple_review__claude-sonnet-4-20250514__t-0.00__p-1.00__c-3.00___swe_bench_verified_test", "instance_id": "django__django-11265", "model_patch": "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex d69c24419b..35c78d7366 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -1666,7 +1666,26 @@ class Query(BaseExpression):\n             filter_expr = (filter_lhs, OuterRef(filter_rhs.name))\n         # Generate the inner query.\n         query = Query(self.model)\n+        # Copy annotations and filtered relations from the original query\n+        # so that they are available in the subquery for exclude operations\n+        query.annotations = self.annotations.copy()\n+        for alias, filtered_relation in self._filtered_relations.items():\n+            # Clone the filtered relation to avoid modifying the original\n+            cloned_filtered_relation = filtered_relation.clone()\n+            query.add_filtered_relation(cloned_filtered_relation, alias)\n         query.add_filter(filter_expr)\n+        \n+        # Before trimming, extract FilteredRelation conditions and add them to WHERE clause\n+        # This ensures they are preserved even if the joins are optimized away\n+        for alias, filtered_relation in query._filtered_relations.items():\n+            if alias in query.alias_map:\n+                join = query.alias_map[alias]\n+                if hasattr(join, 'filtered_relation') and join.filtered_relation:\n+                    # Build the condition from the FilteredRelation and add it to WHERE\n+                    condition_q = join.filtered_relation.condition\n+                    where_clause = query.build_filtered_relation_q(condition_q, reuse=set())\n+                    query.where.add(where_clause, AND)\n+        \n         query.clear_ordering(True)\n         # Try to have as simple as possible subquery -> trim leading joins from\n         # the subquery.\n"}