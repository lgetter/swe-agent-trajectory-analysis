{"model_name_or_path": "250522_anthropic_filemap_simple_review__claude-sonnet-4-20250514__t-0.00__p-1.00__c-3.00___swe_bench_verified_test", "instance_id": "astropy__astropy-13977", "model_patch": "diff --git a/astropy/units/quantity.py b/astropy/units/quantity.py\nindex b98abfafb0..e07c19d76b 100644\n--- a/astropy/units/quantity.py\n+++ b/astropy/units/quantity.py\n@@ -640,7 +640,23 @@ class Quantity(np.ndarray):\n         # input to that expected (e.g., radian for np.sin), or to get\n         # consistent units between two inputs (e.g., in np.add) --\n         # and the unit of the result (or tuple of units for nout > 1).\n-        converters, unit = converters_and_unit(function, method, *inputs)\n+        try:\n+            converters, unit = converters_and_unit(function, method, *inputs)\n+        except TypeError as e:\n+            # Only catch TypeError related to unsupported operand types,\n+            # not other TypeErrors like UnitTypeError which should be propagated\n+            if \"Unsupported operand type(s) for ufunc\" in str(e):\n+                # Check if any of the other inputs have __array_ufunc__ method\n+                # If so, return NotImplemented to allow them to handle the operation\n+                # via their reflected methods (e.g., __radd__, __rmul__, etc.).\n+                for inp in inputs:\n+                    if inp is not self and hasattr(inp, '__array_ufunc__'):\n+                        return NotImplemented\n+                # If no other input has __array_ufunc__, re-raise the original error\n+                raise\n+            else:\n+                # Re-raise other TypeErrors\n+                raise\n \n         out = kwargs.get(\"out\", None)\n         # Avoid loop back by turning any Quantity output into array views.\n@@ -667,7 +683,13 @@ class Quantity(np.ndarray):\n         arrays = []\n         for input_, converter in zip(inputs, converters):\n             input_ = getattr(input_, \"value\", input_)\n-            arrays.append(converter(input_) if converter else input_)\n+            try:\n+                arrays.append(converter(input_) if converter else input_)\n+            except (ValueError, TypeError):\n+                # If we cannot convert the input (e.g., incompatible input types),\n+                # return NotImplemented to allow other objects to handle the operation\n+                # via their reflected methods (e.g., __radd__, __rmul__, etc.).\n+                return NotImplemented\n \n         # Call our superclass's __array_ufunc__\n         result = super().__array_ufunc__(function, method, *arrays, **kwargs)\ndiff --git a/pyproject.toml b/pyproject.toml\nindex 486d6b9b3b..1c5f74f3a1 100644\n--- a/pyproject.toml\n+++ b/pyproject.toml\n@@ -1,5 +1,5 @@\n [build-system]\n-requires = [\"setuptools\",\n+requires = [\"setuptools==68.0.0\",\n             \"setuptools_scm>=6.2\",\n             \"wheel\",\n             \"cython==0.29.30\",\n"}